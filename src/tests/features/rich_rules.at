FWD_START_TEST([rich rules])
AT_KEYWORDS(policy rich)
dnl
dnl This is basic rich rule coverage. Each feature has its own coverage which
dnl should include rich rules as well.

FWD_CHECK([--permanent --new-policy=foobar], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --add-ingress-zone ANY], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --add-egress-zone HOST], 0, [ignore])
FWD_RELOAD

dnl basic layout
dnl
dnl NFT_LIST_RULES([inet], [filter_policy_foobar], 0, [dnl
dnl     table inet firewalld {
dnl         chain filter_policy_foobar {
dnl             jump filter_policy_foobar_pre
dnl             jump filter_policy_foobar_log
dnl             jump filter_policy_foobar_deny
dnl             jump filter_policy_foobar_allow
dnl             jump filter_policy_foobar_post
dnl         }
dnl     }
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar], 0, [dnl
dnl     pol_foobar_pre all -- 0.0.0.0/0 0.0.0.0/0
dnl     pol_foobar_log all -- 0.0.0.0/0 0.0.0.0/0
dnl     pol_foobar_deny all -- 0.0.0.0/0 0.0.0.0/0
dnl     pol_foobar_allow all -- 0.0.0.0/0 0.0.0.0/0
dnl     pol_foobar_post all -- 0.0.0.0/0 0.0.0.0/0
dnl ])
dnl IP6TABLES_LIST_RULES([filter], [pol_foobar], 0, [dnl
dnl     pol_foobar_pre all ::/0 ::/0
dnl     pol_foobar_log all ::/0 ::/0
dnl     pol_foobar_deny all ::/0 ::/0
dnl     pol_foobar_allow all ::/0 ::/0
dnl     pol_foobar_post all ::/0 ::/0
dnl ])

dnl priority
dnl
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv4             source address=10.10.10.10 accept'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv4 priority=0  source address=10.10.10.11 log accept'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv4 priority=0  source address=10.10.10.11 audit accept'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv4 priority=0  source address=10.10.10.12 reject'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv4 priority=0  source address=10.10.10.13 drop'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv4 priority=-1 source address=10.10.10.14 accept'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv4 priority=1  source address=10.10.10.15 accept'], 0, ignore)
FWD_RELOAD
dnl NFT_LIST_RULES([inet], [filter_policy_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])
dnl NFT_LIST_RULES([inet], [filter_policy_foobar_log], 0, [dnl
dnl     FIXME
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar_log], 0, [dnl
dnl     FIXME
dnl ])
dnl NFT_LIST_RULES([inet], [filter_policy_foobar_deny], 0, [dnl
dnl     FIXME
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar_deny], 0, [dnl
dnl     FIXME
dnl ])
dnl NFT_LIST_RULES([inet], [filter_policy_foobar_allow], 0, [dnl
dnl     FIXME
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar_allow], 0, [dnl
dnl     FIXME
dnl ])
dnl NFT_LIST_RULES([inet], [filter_policy_foobar_post], 0, [dnl
dnl     FIXME
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar_post], 0, [dnl
dnl     FIXME
dnl ])

dnl source/destination
dnl
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv4 priority=-1 source address=10.20.20.20 accept'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv4 priority=-2 destination address=10.20.20.21 accept'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv4 priority=-3 source address=10.20.20.22 destination address=10.20.20.23 drop'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv6 priority=-4 source address=1234::4321 destination address=1234::4444 drop'], 0, ignore)
FWD_RELOAD
dnl NFT_LIST_RULES([inet], [filter_policy_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])
dnl IP6TABLES_LIST_RULES([filter], [pol_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])

dnl icmp-type
dnl
FWD_CHECK([--permanent --add-rich-rule='rule family=ipv6 priority=-1 icmp-type name="neighbour-advertisement" accept'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule priority=-2 icmp-type name="echo-request" accept'], 0, ignore)
FWD_RELOAD
dnl NFT_LIST_RULES([inet], [filter_policy_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])
dnl IP6TABLES_LIST_RULES([filter], [pol_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])

dnl mark action
dnl
FWD_CHECK([--permanent --add-rich-rule='rule priority=-1 mark set=1234'], 0, ignore)
FWD_RELOAD
dnl NFT_LIST_RULES([inet], [mangle_policy_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])
dnl IPTABLES_LIST_RULES([mangle], [pol_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])
dnl IP6TABLES_LIST_RULES([mangle], [pol_foobar_pre], 0, [dnl
dnl     FIXME
dnl ])

dnl FIXME: check mark action only valid if
dnl         - egress zone is HOST or ANY

dnl log/audit action
dnl
FWD_CHECK([--permanent --add-rich-rule='rule priority=32000 log prefix="LOG: " level="warning"'], 0, ignore)
FWD_CHECK([--permanent --add-rich-rule='rule priority=32001 audit accept'], 0, ignore)
FWD_RELOAD
dnl NFT_LIST_RULES([inet], [filter_policy_foobar_post], 0, [dnl
dnl     FIXME
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar_post], 0, [dnl
dnl     FIXME
dnl ])
dnl IP6TABLES_LIST_RULES([filter], [pol_foobar_post], 0, [dnl
dnl     FIXME
dnl ])

FWD_END_TEST
