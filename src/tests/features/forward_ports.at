FWD_START_TEST([forward ports])
AT_KEYWORDS(policy forward_port)

FWD_CHECK([--permanent --new-policy=foobar], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --add-ingress-zone ANY], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --add-egress-zone HOST], 0, [ignore])

dnl permanent --> runtime
FWD_CHECK([--permanent --policy=foobar --add-forward-port port=22:proto=tcp:toport=2222], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --add-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --add-forward-port port=44:proto=udp:toport=4444:toaddr=1234::4321], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --add-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 0, [ignore])
FWD_CHECK([--permanent --policy foobar --query-forward-port port=22:proto=tcp:toport=2222], 0, ignore)
FWD_CHECK([--permanent --policy foobar --query-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, ignore)
FWD_CHECK([--permanent --policy foobar --query-forward-port port=44:proto=udp:toport=4444:toaddr=1234::4321], 0, ignore)
FWD_CHECK([--permanent --policy=foobar --query-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 0, [ignore])
FWD_RELOAD
FWD_CHECK([--policy foobar --query-forward-port port=22:proto=tcp:toport=2222], 0, ignore)
FWD_CHECK([--policy foobar --query-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, ignore)
FWD_CHECK([--policy foobar --query-forward-port port=44:proto=udp:toport=4444:toaddr=1234::4321], 0, ignore)
FWD_CHECK([--policy=foobar --query-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 0, [ignore])
dnl NFT_LIST_RULES([inet], [filter_policy_foobar_allow], 0, [dnl
dnl     FIXME: verify rules added
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar_allow], 0, [dnl
dnl     FIXME: verify rules added
dnl ])
dnl IP6TABLES_LIST_RULES([filter], [pol_foobar_allow], 0, [dnl
dnl     FIXME: verify rules added
dnl ])
FWD_CHECK([--permanent --policy=foobar --remove-forward-port port=22:proto=tcp:toport=2222], 0, [ignore])
FWD_CHECK([--permanent --policy foobar --query-forward-port port=22:proto=tcp:toport=2222], 1, [ignore])
FWD_CHECK([--permanent --policy foobar --query-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --remove-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --remove-forward-port port=44:proto=udp:toport=4444:toaddr=1234::4321], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --remove-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 0, [ignore])
FWD_CHECK([--policy=foobar --remove-forward-port port=22:proto=tcp:toport=2222], 0, [ignore])
FWD_CHECK([--policy foobar --query-forward-port port=22:proto=tcp:toport=2222], 1, [ignore])
FWD_CHECK([--policy foobar --query-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, [ignore])
FWD_CHECK([--policy=foobar --remove-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, [ignore])
FWD_CHECK([--policy=foobar --remove-forward-port port=44:proto=udp:toport=4444:toaddr=1234::4321], 0, [ignore])
FWD_CHECK([--policy=foobar --remove-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 0, [ignore])

dnl runtime --> permanent
m4_ifdef([TESTING_FIREWALL_OFFLINE_CMD], [],
FWD_CHECK([--policy=foobar --add-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, [ignore])
FWD_CHECK([--policy=foobar --add-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 0, [ignore])
FWD_CHECK([--policy foobar --query-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, [ignore])
FWD_CHECK([--policy=foobar --query-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 0, [ignore])
FWD_CHECK([--runtime-to-permanent], 0, [ignore])
FWD_CHECK([--permanent --policy foobar --query-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --query-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 0, [ignore])
dnl NFT_LIST_RULES([inet], [filter_policy_foobar_allow], 0, [dnl
dnl     FIXME: verify rules added w/ helper rule
dnl ])
dnl IPTABLES_LIST_RULES([filter], [pol_foobar_allow], 0, [dnl
dnl     FIXME: verify rules added
dnl ])
dnl IP6TABLES_LIST_RULES([filter], [pol_foobar_allow], 0, [dnl
dnl     FIXME: verify rules added
dnl ])
FWD_CHECK([--permanent --policy=foobar --remove-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, [ignore])
FWD_CHECK([--permanent --policy=foobar --remove-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 0, [ignore])
FWD_CHECK([--permanent --policy foobar --query-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 1, [ignore])
FWD_CHECK([--permanent --policy=foobar --query-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 1, [ignore])
FWD_CHECK([--policy=foobar --remove-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 0, [ignore])
FWD_CHECK([--policy=foobar --remove-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 0, [ignore])
FWD_CHECK([--policy foobar --query-forward-port port=33:proto=tcp:toport=33:toaddr=10.10.10.10], 1, [ignore])
FWD_CHECK([--policy=foobar --query-rich-rule='rule family=ipv4 forward-port port=444 protocol=udp to-port=4444 to-addr=10.44.44.44'], 1, [ignore])
])

dnl invalid ports
FWD_CHECK([--permanent --policy=foobar --add-forward-port 1234], 106, [ignore], [ignore])
FWD_CHECK([--policy=foobar --add-forward-port 1234], 106, [ignore], [ignore])
FWD_CHECK([--permanent --policy=foobar --add-forward-port port=11:proto=tcp], 106, [ignore], [ignore])
FWD_CHECK([--policy=foobar --add-forward-port port=11:proto=tcp], 106, [ignore], [ignore])
FWD_CHECK([--permanent --policy=foobar --add-forward-port port=11:proto=tcpp:toport=1111], 103, [ignore], [ignore])
FWD_CHECK([--policy=foobar --add-forward-port port=11:proto=tcpp:toport=1111], 103, [ignore], [ignore])
FWD_CHECK([--permanent --policy=foobar --add-forward-port port=11:proto=tcp:toport=1111:toaddr=10.10.10.10.10], 105, [ignore], [ignore])
FWD_CHECK([--policy=foobar --add-forward-port port=11:proto=tcp:toport=1111:toaddr=10.10.10.10.10], 105, [ignore], [ignore])

FWD_CHECK([--permanent --policy=foobar --add-rich-rule='rule family=ipv4 forward-port port=444'], 103, [ignore], [ignore])
FWD_CHECK([            --policy=foobar --add-rich-rule='rule family=ipv4 forward-port port=444'], 103, [ignore], [ignore])
FWD_CHECK([--permanent --policy=foobar --add-rich-rule='rule family=ipv4 forward-port port=444 protocol=tcp'], 102, [ignore], [ignore])
FWD_CHECK([            --policy=foobar --add-rich-rule='rule family=ipv4 forward-port port=444 protocol=tcp'], 102, [ignore], [ignore])
FWD_CHECK([--permanent --policy=foobar --add-rich-rule='rule family=ipv4 forward-port port=444 protocol=tcpp to-port=1111'], 103, [ignore], [ignore])
FWD_CHECK([            --policy=foobar --add-rich-rule='rule family=ipv4 forward-port port=444 protocol=tcpp to-port=1111'], 103, [ignore], [ignore])
FWD_CHECK([--permanent --policy=foobar --add-rich-rule='rule family=ipv4 forward-port port=444 protocol=tcp to-port=1111 to-addr=10.10.10.10.10'], 105, [ignore], [ignore])
FWD_CHECK([            --policy=foobar --add-rich-rule='rule family=ipv4 forward-port port=444 protocol=tcp to-port=1111 to-addr=10.10.10.10.10'], 105, [ignore], [ignore])

dnl FIXME: check only valid if:
dnl         - egress-zone is HOST and to-addr not specified
dnl         - egress-zone is ANY and to-addr is specified

FWD_END_TEST
